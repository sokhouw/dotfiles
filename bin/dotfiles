#!/usr/bin/env sh

RED=$(printf '\033[1;31m')
GREEN=$(printf '\033[1;32m')
# BLUE=$(printf '\033[1;34m')
YELLOW=$(printf '\033[1;33m')
GREY=$(printf '\033[1;30m')
RESET=$(printf '\033[0;m')

# root directory of dotfiles project. We're copying files from here
ROOT_DIR="$(cd "$(dirname "$0")/.." && pwd)"

# ------------------------------------------------------------------------------
# os commands
# ------------------------------------------------------------------------------

os_cmd() {
    cmd="${1}"
    printf '%s: ' "$*"
    shift 1
    if error=$("${cmd}" "$@" 2>&1 >/dev/null); then
        printf '%sok%s\n' "${GREEN}" "${RESET}"
    else
        printf '%s%s%s\n' "${RED}" "${error}" "${RESET}"
        exit 1
    fi
}

# ------------------------------------------------------------------------------
# printing messages
# ------------------------------------------------------------------------------

msg_error() {
    printf '%s[ERROR]%s %s\n' "${RED}" "${RESET}" "${1}"
}

msg_warn() {
    printf '%s[WARN]%s %s\n' "${YELLOW}" "${RESET}" "${1}"
}

msg_info() {
    printf '%s[INFO]%s %s\n' "${GREY}" "${RESET}" "${1}"
}

# ------------------------------------------------------------------------------
# install actions
# ------------------------------------------------------------------------------

install_ensure_dir() {
    if [ -d "${1}" ]; then
        if [ ! -w "${1}" ]; then
            printf 'directory %s: %snot writeable%s\n' "${1}" "${RED}" "${RESET}"
            exit 1
        fi
    else
        if [ ! -d "$(dirname "${1}")" ]; then
            install_ensure_dir "$(dirname "${1}")"
        fi
        if error=$(mkdir "${1}" 2>&1 >/dev/null); then
            printf 'directory %s: %screated%s\n' "${1}" "${GREEN}" "${RESET}"
            uninstall_instr rmdir "${1}"
        else
            printf 'directory %s: %s%s%s\n' "${1}" "${RED}" "${error}" "${RESET}"
            exit 1
        fi
    fi
}

install_config() {
    if [ "${INSTALL_SOFT_LINKING}" = "1" ]; then
        os_cmd ln -sf "${1}" "${CONFIG_HOME}"/$(basename "${1}")
        uninstall_instr rm "${CONFIG_HOME}"/$(basename "${1}")
    else
        os_cmd cp -r "${1}" "${CONFIG_HOME}"/$(basename "${1}")
        uninstall_instr rm -rf "${CONFIG_HOME}"/$(basename "${1}")
    fi
}

install_create_backup_mv() {
    if [ -e "${1}" ]; then
        os_cmd mv "${1}" "${1}".bak
        uninstall_instr mv "${1}".bak "${1}"
    fi
}

install_create_backup_cp() {
    if [ -e "${1}" ]; then
        os_cmd cp "${1}" "${1}".bak
        uninstall_instr mv -f "${1}".bak "${1}"
    fi
}

install_soft_link() {
    if [ ! -e "${2}" ]; then
        install_create_backup_mv "${2}"
    fi
    os_cmd ln -s "${1}" "${2}"
    uninstall_instr rm "${2}"
}

install_tmux_plugin() {
    echo "cloning ${1} into ${2}: "
    printf '%s' "${GREY}"
    if GIT_TERMINAL_PROMPT=0 git -c credential.helper= clone "https://github.com/${1}" "${2}"; then
        printf '%s' "${RESET}"
        printf '%sok%s\n' "${GREEN}" "${RESET}"
        uninstall_instr rm -rf "${2}"
        return 0
    else
        printf '%s' "${RESET}"
        printf '%sfailed%s\n' "${RED}" "${RESET}"
        exit 1
    fi
}

install_bash_modules() {
    if [ -f "${HOME_DIR}"/.bashrc ] && [ -w "${HOME_DIR}"/.bashrc ]; then
        install_create_backup_cp "${HOME_DIR}"/.bashrc
        bash_init="${CONFIG_HOME}/shell/bash/init.sh"
        printf 'installing bash modules: '
        if printf '\n# dotfiles addition\nsource "%s" "%s"\n' "${bash_init}" "${bash_init}" >> "${HOME_DIR}"/.bashrc; then
            printf '%sok%s\n' "${GREEN}" "${RESET}"
        else
            printf '%sfailed%s\n' "${RED}" "${RESET}"
            exit 1
        fi
    fi
}

# ------------------------------------------------------------------------------
# function install
# ------------------------------------------------------------------------------

install() {
    UNINSTALL_FILE=$(mktemp)
    install_ensure_dir "${STATE_HOME}"
    install_ensure_dir "${STATE_HOME}/dotfiles"
    mv "${UNINSTALL_FILE}" "${STATE_HOME}"/dotfiles/uninstall
    UNINSTALL_FILE="${STATE_HOME}"/dotfiles/uninstall
    install_ensure_dir "${STATE_HOME}/dotfiles/backup"
    install_ensure_dir "${CONFIG_HOME}"
    for f in "${ROOT_DIR}/config"/*; do
        install_config "${f}"
    done 
    install_soft_link "${CONFIG_HOME}/tmux/tmux.conf" "${HOME_DIR}"/.tmux.conf
    install_ensure_dir "${STATE_HOME}"/tmux/plugins
    grep "^set -g @plugin" "${ROOT_DIR}/config/tmux/tmux.conf" | cut -f4 -d' ' | sed "s/'//g" | while IFS= read -r plugin; do
        install_tmux_plugin "${plugin}" "${STATE_HOME}/tmux/plugins/$(basename ${plugin})"
    done || exit 1 # that constructs creates subshell thus we use "|| exit 1" to propagate error up
    install_bash_modules
    INSTALL_OK=1
}

# ------------------------------------------------------------------------------

install_on_exit() {
    if [ -f "${UNINSTALL_FILE}" ]; then
        # reverse the order of uninstall instructions
        sed -i '1!G;h;$!d' "${UNINSTALL_FILE}"
        if [ -z "${INSTALL_OK}" ]; then
            uninstall
        fi
    fi
}

# ------------------------------------------------------------------------------
# function uninstall
# ------------------------------------------------------------------------------

uninstall() {
    if [ -z "${UNINSTALL_FILE}" ]; then
        UNINSTALL_FILE="${STATE_HOME}"/dotfiles/uninstall
    fi
    # move uninstall file to temp location so its parent dir can be rmdir-ed
    instr_file="$(mktemp)"
    mv -f "${UNINSTALL_FILE}" "${instr_file}"
    cat "${instr_file}" | while IFS= read -r cmd; do
        printf '%s: ' "${cmd}"
        if error=$(sh -c "${cmd}" 2<&1 >/dev/null); then
            printf '%sok%s\n' "${GREEN}" "${RESET}"
        else
            printf '%s%s%s\n' "${RED}" "${error}" "${RESET}"
        fi
    done
}

uninstall_instr() {
    echo "$*" >> "${UNINSTALL_FILE}"
}


# ------------------------------------------------------------------------------
# function prepare
#   create global variables with values depending on cmd-line arguments
# ------------------------------------------------------------------------------

prepare() {
    PROFILE="default"
    VERBOSE=""
    HOME_DIR="${HOME}"
    shift 1

    # process command-line arguments
    while [ ! -z "${1}" ]; do
        case "${1}" in
            --test)
                PROFILE="test"
                HOME_DIR="/tmp/dotfiles"
                shift 1
                ;;
            --verbose)
                VERBOSE="1"
                shift 1
                ;;
            --soft-link)
                if [ "${COMMAND}" = "install" ]; then
                    INSTALL_SOFT_LINKING="1"
                else
                    bad_args
                fi
                shift 1
        esac
    done

    # use XDG variables if set or in test profile, otherwise use their defaults
    if [ -z "${XDG_CONFIG_HOME}" ] || [ "${PROFILE}" = "test" ]; then
        CONFIG_HOME="${HOME_DIR}/.config"
    else
        CONFIG_HOME="${XDG_CONFIG_HOME}"
    fi
    if [ -z "${XDG_STATE_HOME}" ] || [ "${PROFILE}" = "test" ]; then
        STATE_HOME="${HOME_DIR}/.local/state"
    else
        STATE_HOME="${XDG_STATE_HOME}"
    fi

    # set global variables
    DOTFILES_LINK="${HOME_DIR}/.dotfiles"
    BIN_HOME="${HOME_DIR}/bin"

    if [ ! -z "${VERBOSE}" ]; then
        msg_info "ROOT_DIR=\"${ROOT_DIR}\""
        msg_info "HOME_DIR=\"${HOME_DIR}\""
        msg_info "CONFIG_HOME=\"${CONFIG_HOME}\""
        msg_info "STATE_HOME=\"${STATE_HOME}\""
        msg_info "UNINSTALL_FILE=\"${UNINSTALL_FILE}\""
    fi

    # add some content to test home dir in test profile
    if [ "${COMMAND}" = "install" ] && [ "${PROFILE}" = "test" ]; then
        mkdir "${HOME_DIR}"
        touch "${HOME_DIR}/.bashrc"
        printf "# line 1\n# line 2\n" >> "${HOME_DIR}/.bashrc"
    fi
}

# ------------------------------------------------------------------------------
# funtion: bad_args
# ------------------------------------------------------------------------------

bad_args() {
    msg_error "Bad arguments."
    echo "Usage:"
    echo "  dotfiles install [--test] [--verbose] [--soft-link]"
    echo "  dotfiles uninstall [--test] [--verbose]"
    echo "  dotfiles checkhealth [--test] [--verbose]"
    exit 1
}

# ------------------------------------------------------------------------------
# main program
# ------------------------------------------------------------------------------

COMMAND="${1}"
case "${COMMAND}" in
    install)
        trap install_on_exit EXIT
        prepare "$@"
        install
        ;;
    uninstall)
        prepare "$@"
        uninstall
        ;;
    checkhealth)
        prepare "$@"
        ;;
    *)
        bad_args
        ;;
esac
